#!/usr/bin/env python
# -*- encoding: utf-8 -*-
import os
import sys
import requests
try:
    import json
    import subprocess
except: pass

public = False
base = "meta:firestarter auto_tagged tag_me"
tags = base


for file in sys.argv[1:]:
    if file == "-p":
        public = True
    elif file == "-s":
        tags = "%s meta:screenshot" % base
    else:
        response = requests.post("http://ablaze.web/api/media/upload", files={"file": open(file, "rb").read()}, params={"tags": tags})
        content = response.content.decode("utf-8")
        print(content)
        try:
            data = json.loads(content)
            if public:
                requests.get("http://ablaze.web/api/media/%i/public" % data["id"])
                data["url"] = data["url"].replace("ablaze.cdn/cdn","flymr.liquidcode.net")
            proc = subprocess.Popen(["xclip","-selection","c"], stdin=subprocess.PIPE)
            proc.communicate(data["url"].encode("utf-8"))
        except: pass
